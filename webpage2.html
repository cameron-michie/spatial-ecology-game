<!DOCTYPE html>
<html>
<head>
    <title>Ably Realtime Image Display</title>
    <script src="https://cdn.ably.io/lib/ably.min-1.js"></script> <!-- Ably library -->
</head>
<style> 
    .bigger-image{
        width:700px; 
        image-resolution:500dpi;
        image-rendering: pixelated;
        } 
</style>
<body>
    <h1>Ably Realtime Image Display</h1>
    <img id="imageDisplay" alt="Realtime Image" class="bigger-image" />
    <p id="message-count"> Message count = 0</p>
    <div id="presence-data"></div>

    <script>
        // Initialize Ably
        const ably = new Ably.Realtime('EKxBlQ.bVI3ng:10FVabjayrOT2uTY46zlgR1_DLLDWtqvGbLVaLy_BS8');
        const channel = ably.channels.get('spatial-ecology-game');
    
        let clientId = "user_" + Date.now(); // Unique ID for each client
    
        // Subscribe to image messages
        let messageCounter = 0;
        channel.subscribe('image-message', (message) => {
            displayImage(message.data);
            messageCounter++;
            document.getElementById("message-count").innerHTML = "Message count = " + messageCounter;
        });
    
        // Function to display image
        function displayImage(base64String) {
            var imgSrc = 'data:image/png;base64,' + base64String;
            document.getElementById('imageDisplay').src = imgSrc;
        }
    
        // Enter the channel presence
        channel.presence.enter(clientId, (err) => {
            if(err) {
                console.error('Error entering presence:', err);
            } else {
                console.log('Entered presence with ID:', clientId);
            }
        });
    
        // Key press event listener
        document.addEventListener('keydown', (event) => {
            let direction;
            switch(event.key) {
                case "ArrowLeft":
                    direction = "LEFT";
                    break;
                case "ArrowRight":
                    direction = "RIGHT";
                    break;
                case "ArrowUp":
                    direction = "UP";
                    break;
                case "ArrowDown":
                    direction = "DOWN";
                    break;
                default:
                    return; // Ignore other keys
            }
    
            // Publish direction message
            channel.publish(`user-${clientId}-moves`, direction, (err) => {
                if(err) {
                    console.error('Error publishing message:', err);
                } else {
                    console.log('Published direction:', direction);
                }
            });
        });

        // Function to update presence data on the page
        function updatePresenceData(presenceData) {
            const presenceDiv = document.getElementById('presence-data');
            presenceDiv.innerHTML = 'Users in Channel: <br>' + presenceData.map(member => member.clientId).join('<br>');
        }

        // Subscribe to presence changes
        channel.presence.subscribe((presenceMessage) => {
            channel.presence.get((err, presenceMembers) => {
                if (err) {
                    console.error('Error fetching presence data:', err);
                } else {
                    updatePresenceData(presenceMembers);
                }
            });
        });

        // Initial fetch of presence data
        channel.presence.get((err, presenceMembers) => {
            if (err) {
                console.error('Error fetching presence data:', err);
            } else {
                updatePresenceData(presenceMembers);
            }
        });
    </script>
    
</body>
</html>
